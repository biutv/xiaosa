name: Download and Update Files

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # 每小时运行一次（更标准的cron语法）

jobs:
  download-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download file from Gitee
        run: |
          # 创建临时目录
          mkdir -p temp_download
          cd temp_download
          
          echo "开始从Gitee下载文件..."
          # 使用Gitee API获取下载链接（需要处理JSON响应）
          download_url=$(curl -s "https://gitee.com/api/v5/repos/PizazzXS/another-d/contents/单线路.zip" | grep -oP '"download_url": "\K[^"]+')
          
          if [ -z "$download_url" ]; then
            echo "错误：无法从API获取下载链接"
            exit 1
          fi
          
          echo "获取到下载链接: $download_url"
          curl -L -o "single_line.zip" "$download_url"
          
          if [ -f "single_line.zip" ]; then
            echo "文件下载成功，开始解压..."
            unzip -o single_line.zip -d ../
            echo "文件解压完成"
          else
            echo "文件下载失败"
            exit 1
          fi
          
          # 清理临时文件
          cd ..
          rm -rf temp_download

      - name: Check and commit changes
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "检测到文件变更，提交更新..."
            git add .
            git commit -m "Update: 更新单线路文件 $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "更新已推送到仓库"
          else
            echo "没有检测到文件变更"
          fi
